#!/bin/bash

service="dev"

usage() {
  cat <<USAGE
Usage:
  acc up
  acc test [cpp|cpy|pypy] [dir]
  acc logs server [option]
  acc yank [filename]
Examples:
  acc up
  acc test        # lang=cpp, dir=.
  acc test cpy    # dir=.
  acc test pypy contests/abc001/abc001_a
  acc logs server
  acc logs server -f          # realtime
  acc logs server --tail=20   # only last 20 lines
  acc yank        # filename=main.cpp
  acc yank main.py
USAGE
}

# ホストのカレントディレクトリからコンテナの作業ディレクトリを作る
script_path="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/$(basename "${BASH_SOURCE[0]}")"
script_real="$(python3 -c 'import os,sys; print(os.path.realpath(sys.argv[1]))' "${BASH_SOURCE[0]}")"

host_script_abspath="$(cd "$(dirname "$script_real")" && pwd)"
host_repo_root="$(cd "$host_script_abspath/.." && pwd)"
current_abspath="$(pwd)"

if [[ "$current_abspath" == "$host_repo_root" ]]; then
  relpath="."
elif [[ "$current_abspath" == "$host_repo_root/"* ]]; then
  relpath="${current_abspath#"$host_repo_root"/}"
else
  echo "[ac] current directory is outside repo" >&2
  exit 2
fi

container_work_abspath="/workspace/"${relpath}""

cmd="${1:-}"
if [ "$#" -gt 0 ]; then
  shift
fi

case "$cmd" in
help | -h)
  usage
  exit 0
  ;;
test | t)
  lang="${1:-cpp}"

  case "$lang" in
  cpp | cpy | pypy) ;;
  *)
    echo "unknown lang: $lang" >&2
    exit 2
    ;;
  esac

  exec docker compose exec -T "$service" /workspace/scripts/run_tests.sh "$lang" "$container_work_abspath"
  ;;
up | u)
  # scripts/dev.sh を repo root を cwd にして実行
  cd -- "$host_repo_root"
  exec "$host_repo_root/scripts/dev.sh" "$@"
  ;;
logs | l)
  subcmd="${1:-}"
  if [ "$#" -gt 0 ]; then
    shift
  fi

  case "$subcmd" in
  server | s)
    exec docker compose logs "$@" dev
    ;;
  *)
    usage
    exit 2
    ;;
  esac
  ;;
yank | y)
  file="${1:-main.cpp}"

  tmp="$(mktemp)"
  cat "$file" >"$tmp"

  if cat "$tmp" | pbcopy; then
    lines="$(wc -l <"$tmp" | tr -d ' ')"
    echo "✔ copied to clipboard: $file ($lines lines)"
    echo "---- preview ----"
    sed -n '1,5p' "$tmp"
    [ "$lines" -gt 5 ] && echo "..."
  else
    echo "✖ failed to copy to clipboard" >&2
    rm -f "$tmp"
    exit 1
  fi

  rm -f "$tmp"
  ;;
*)
  usage
  exit 2
  ;;
esac
