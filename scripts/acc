#!/bin/bash

service="dev"

usage() {
  cat <<USAGE
Usage:
  acc init
  acc test [cpp|py] [dir]
  acc yank [filename]
Examples:
  acc init
  acc up
  acc test        # lang=cpp, dir=.
  acc test py     # dir=.
  acc test py contests/abc001/abc001_a
  acc yank        # filename=main.cpp
  acc yank main.py
USAGE
}

# ホストのカレントディレクトリからコンテナの作業ディレクトリを作る
script_path="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/$(basename "${BASH_SOURCE[0]}")"
script_real="$(python3 -c 'import os,sys; print(os.path.realpath(sys.argv[1]))' "${BASH_SOURCE[0]}")"

script_abspath="$(cd "$(dirname "$script_real")" && pwd)"
repo_root="$(cd "$script_abspath/.." && pwd)"
current_abspath="$(pwd)"

if [[ "$current_abspath" == "$host_repo_root" ]]; then
  relpath="."
elif [[ "$current_abspath" == "$host_repo_root/"* ]]; then
  relpath="${current_abspath#"$host_repo_root"/}"
else
  echo "[ac] current directory is outside repo" >&2
  exit 2
fi

cmd="${1:-}"
if [ "$#" -gt 0 ]; then
  shift
fi

case "$cmd" in
help | -h | h)
  usage
  exit 0
  ;;
init | i)
  exec $repo_root/scripts/init.sh
  ;;
test | t)
  lang="${1:-cpp}"

  case "$lang" in
  cpp | py) ;;
  *)
    echo "unknown lang: $lang" >&2
    exit 2
    ;;
  esac

  exec $repo_root/scripts/run_tests.sh "$lang"
  ;;
up | u)
  exec python3 $repo_root/scripts/cc_server.py
  ;;
yank | y)
  file="${1:-main.cpp}"

  tmp="$(mktemp)"
  cat "$file" >"$tmp"

  if cat "$tmp" | pbcopy; then
    lines="$(wc -l <"$tmp" | tr -d ' ')"
    echo "✔ copied to clipboard: $file ($lines lines)"
    echo "---- preview ----"
    sed -n '1,5p' "$tmp"
    [ "$lines" -gt 5 ] && echo "..."
  else
    echo "✖ failed to copy to clipboard" >&2
    rm -f "$tmp"
    exit 1
  fi

  rm -f "$tmp"
  ;;
*)
  usage
  exit 2
  ;;
esac
