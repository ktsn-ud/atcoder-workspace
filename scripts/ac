#!/bin/bash

usage() {
  cat <<USAGE
Usage:
  ac test [cpp|cpy|pypy] [dir]
  ac yank [filename]
Examples:
  ac test         # lang=cpp, dir=.
  ac test cpy     # dir=.
  ac test pypy contests/abc001/abc001_a
  ac yank         # filename=main.cpp
  ac yank main.py
  ac open         # ext=cpp
  ac open py
USAGE
}

osc52_copy() {
  local data
  data="$(base64 | tr -d '\n')"
  printf '\033]52;c;%s\a' "$data"
}

# コンテナ内のカレントディレクトリを取得
current_dir="$(pwd)"
repo_root="/workspace"

# カレントディレクトリがリポジトリ内か確認
if [[ "$current_dir" == "$repo_root" ]]; then
  relpath="."
elif [[ "$current_dir" == "$repo_root/"* ]]; then
  relpath="${current_dir#"$repo_root"/}"
else
  echo "[acc] current directory is outside repo" >&2
  exit 2
fi

container_work_abspath="/workspace/"${relpath}""

cmd="${1:-}"
if [ "$#" -gt 0 ]; then
  shift
fi

case "$cmd" in
help | -h)
  usage
  exit 0
  ;;
test | t)
  lang="${1:-cpp}"

  case "$lang" in
  cpp | cpy | pypy) ;;
  *)
    echo "unknown lang: $lang" >&2
    exit 2
    ;;
  esac

  exec /workspace/scripts/run_tests.sh "$lang" "$container_work_abspath"
  ;;
yank | y)
  file="${1:-main.cpp}"

  tmp="$(mktemp)"
  cat "$file" >"$tmp"

  if cat "$tmp" | osc52_copy; then
    lines="$(wc -l <"$tmp" | tr -d ' ')"
    echo "✔ copied to clipboard: $file ($lines lines)"
    echo "---- preview ----"
    sed -n '1,5p' "$tmp"
    [ "$lines" -gt 5 ] && echo "..."
  else
    echo "✖ failed to copy to clipboard" >&2
    rm -f "$tmp"
    exit 1
  fi

  rm -f "$tmp"
  ;;
open | o)
  ext="${1:-cpp}"

  case "$ext" in
  cpp)
    code main.cpp
    ;;
  py)
    code main.py
    ;;
  *)
    echo "unknown extension: $ext" >&2
    exit 2
    ;;
  esac
  ;;
*)
  usage
  exit 2
  ;;
esac
